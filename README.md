# Markoshka

Небольшая утилита для Raspberry Pi 2W, которая выводит дружеские фразы на дисплей покупателя (20x2). Включённый по автозапуску скрипт показывает приветствие, после чего каждые 5 секунд переключает фразу.

## Возможности
- Три режима показа:
  1. **Подряд** — категории и фразы идут последовательно по кругу.
  2. **Рандом** — выбирается любая фраза из любых категорий.
  3. **По разделу** — стартуем с выбранной категории, показываем её фразы, затем следующие категории по кругу.
- Управление одной кнопкой (GPIO17, `pull_up=True`):
  - Короткое нажатие: переключить режим (Подряд → Рандом → По разделу → ...).
  - Долгое нажатие (1.2+ с): выбрать следующую категорию и сразу перейти в режим «По разделу».
- Приветственное сообщение прокручивается **вверх** построчно на двух строках (20 символов каждая) без посимвольного бегущего текста; рабочие фразы показываются целиком на двух строках, помещаясь в 20 символов.

## Текстовое оформление
- Приветствие длинное, поэтому оно выводится как бегущая строка **вверх** на обеих строках дисплея: каждое предложение прокручивается целиком, подъезжая снизу, а не посимвольно влево. Так текст занимает две строки и остаётся читаемым.
- Рабочие фразы подбирайте так, чтобы каждая целиком помещалась в 20 символов (2 строки по 20 символов при необходимости). В поставке есть 10 тестовых фраз в 9 категориях; их легко заменить на полный список в `markoshka/phrases.py`.

## Запуск
```bash
pip install -r requirements.txt  # на Pi
python main.py
```
При отсутствии `gpiozero` программа работает в консоли: фразы печатаются в терминал, кнопку имитировать не нужно (режим остаётся «Подряд»).

### Автозапуск через systemd
Создайте сервис `/etc/systemd/system/markoshka.service`:
```
[Unit]
Description=Markoshka display loop
After=network.target

[Service]
ExecStart=/usr/bin/python /home/pi/Markoshka/main.py
WorkingDirectory=/home/pi/Markoshka
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
```
Затем выполните:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now markoshka.service
```

## Настройка под дисплей
В проект добавлены драйверы под PD2800 (20x2):
- `PD2800SerialDisplayDriver` — VFD через UART (ESC-команды, кодировка CP866), это драйвер по умолчанию.
- `PD2800DisplayDriver` (I2C, PCF8574) — оставлен для варианта с I2C-платой.

Зависимости ставятся из `requirements.txt` (есть pyserial, RPLCD, gpiozero).

### PD2800 через UART (рекомендовано)
1) Включите UART на Pi и отключите консоль на /dev/serial0 (raspi-config → Interface Options → Serial).
2) Подключите дисплей: GND ↔ GND, VCC ↔ 5V, TX дисплея ↔ GPIO15 (RXD), RX дисплея ↔ GPIO14 (TXD). Если у PD2800 уровни RS-232, ставьте преобразователь уровней до 3.3 В.
3) Запустите: `MARKOSHKALCD_PORT=/dev/serial0 MARKOSHKALCD_BAUD=9600 python main.py` (по умолчанию берутся значения из `config.py`: `/dev/ttyUSB0`, `9600`, но их можно перекрыть переменными окружения).

### PD2800 через I2C (если есть I2C-бэкпак)
1) Включите I2C: `sudo raspi-config nonint do_i2c 0`.
2) Зависимости: `sudo apt install -y python3-pip python3-rpi.gpio i2c-tools && pip install -r requirements.txt`.
3) Подключение: VCC → 5V, GND → GND, SDA → GPIO2 (SDA1), SCL → GPIO3 (SCL1), подсветка A → 5V, K → GND.
4) Определите адрес: `sudo i2cdetect -y 1` (обычно 0x27/0x3F). При необходимости задайте `MARKOSHKALCD_ADDR=0x3F`.

### Принудительный выбор драйвера
- UART: `MARKOSHKALCD_TRANSPORT=serial`
- I2C: `MARKOSHKALCD_TRANSPORT=i2c`
